<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D抛硬币模拟</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #flipButton {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
        }
        #flipButton:hover {
            background-color: #45a049;
        }
        #result {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            font-size: 18px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 5px;
            z-index: 100;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #333;
        }
    </style>
    <!-- 预先加载Three.js和Cannon.js库 -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.159.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.159.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="loading">加载中，请稍候...</div>
    <button id="flipButton">抛硬币</button>
    <div id="result">硬币结果将显示在此处</div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import * as CANNON from 'https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js';

        // DOM元素
        const flipButton = document.getElementById('flipButton');
        const resultElem = document.getElementById('result');
        const loadingElem = document.getElementById('loading');

        // 创建场景
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f0f0);

        // 创建相机
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 10);
        camera.lookAt(0, 0, 0);

        // 创建渲染器
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // 添加轨道控制器便于查看
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // 创建灯光
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 10, 7.5);
        directionalLight.castShadow = true;
        directionalLight.shadow.camera.left = -10;
        directionalLight.shadow.camera.right = 10;
        directionalLight.shadow.camera.top = 10;
        directionalLight.shadow.camera.bottom = -10;
        scene.add(directionalLight);

        // 创建物理世界
        const world = new CANNON.World({
            gravity: new CANNON.Vec3(0, -9.82, 0)
        });

        // 创建地面
        const groundGeometry = new THREE.PlaneGeometry(20, 20);
        const groundMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x999999,
            side: THREE.DoubleSide
        });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // 地面物理体
        const groundShape = new CANNON.Plane();
        const groundBody = new CANNON.Body({ mass: 0 });
        groundBody.addShape(groundShape);
        groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
        world.addBody(groundBody);

        // 创建硬币
        const coinRadius = 1;
        const coinThickness = 0.1;
        const coinGeometry = new THREE.CylinderGeometry(coinRadius, coinRadius, coinThickness, 32);
        
        // 创建材质
        const edgeMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xb87333, // 铜色边缘
            metalness: 0.8, 
            roughness: 0.3 
        });
        
        const headMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xd4af37, // 金色正面
            metalness: 0.8,
            roughness: 0.3
        });
        
        const tailMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xc0c0c0, // 银色反面
            metalness: 0.8,
            roughness: 0.3
        });

        // 使用三种不同的材质（边缘、正面、反面）
        const materials = [
            edgeMaterial, // 边缘
            headMaterial, // 正面
            tailMaterial  // 反面
        ];
        
        // 创建硬币的网格
        const coin = new THREE.Mesh(coinGeometry, materials);
        coin.castShadow = true;
        coin.receiveShadow = true;
        
        // 添加正面文字("正")
        const headCanvas = document.createElement('canvas');
        headCanvas.width = 512; // 增大分辨率
        headCanvas.height = 512;
        const headCtx = headCanvas.getContext('2d');
        
        // 绘制圆形底色
        headCtx.fillStyle = '#d4af37'; // 与材质颜色相同的底色
        headCtx.beginPath();
        headCtx.arc(256, 256, 240, 0, Math.PI * 2);
        headCtx.fill();
        
        // 添加发光效果
        const headGradient = headCtx.createRadialGradient(256, 256, 100, 256, 256, 240);
        headGradient.addColorStop(0, 'rgba(255, 255, 200, 0.8)');
        headGradient.addColorStop(1, 'rgba(255, 215, 0, 0.1)');
        headCtx.fillStyle = headGradient;
        headCtx.beginPath();
        headCtx.arc(256, 256, 240, 0, Math.PI * 2);
        headCtx.fill();
        
        // 绘制清晰的文字
        headCtx.fillStyle = '#8B0000'; // 深红色文字
        headCtx.font = 'bold 240px Arial, "Microsoft YaHei", "黑体", sans-serif';
        headCtx.textAlign = 'center';
        headCtx.textBaseline = 'middle';
        headCtx.fillText('正', 256, 256);
        
        // 添加文字阴影
        headCtx.shadowColor = 'rgba(0, 0, 0, 0.5)';
        headCtx.shadowBlur = 10;
        headCtx.shadowOffsetX = 3;
        headCtx.shadowOffsetY = 3;
        headCtx.fillText('正', 256, 256);
        
        const headTexture = new THREE.CanvasTexture(headCanvas);
        headTexture.anisotropy = renderer.capabilities.getMaxAnisotropy(); // 提高纹理质量
        headMaterial.map = headTexture;
        
        // 添加反面文字("反")
        const tailCanvas = document.createElement('canvas');
        tailCanvas.width = 512;
        tailCanvas.height = 512;
        const tailCtx = tailCanvas.getContext('2d');
        
        // 绘制圆形底色
        tailCtx.fillStyle = '#c0c0c0'; // 与材质颜色相同的底色
        tailCtx.beginPath();
        tailCtx.arc(256, 256, 240, 0, Math.PI * 2);
        tailCtx.fill();
        
        // 添加发光效果
        const tailGradient = tailCtx.createRadialGradient(256, 256, 100, 256, 256, 240);
        tailGradient.addColorStop(0, 'rgba(240, 240, 240, 0.8)');
        tailGradient.addColorStop(1, 'rgba(192, 192, 192, 0.1)');
        tailCtx.fillStyle = tailGradient;
        tailCtx.beginPath();
        tailCtx.arc(256, 256, 240, 0, Math.PI * 2);
        tailCtx.fill();
        
        // 绘制清晰的文字
        tailCtx.fillStyle = '#00008B'; // 深蓝色文字
        tailCtx.font = 'bold 240px Arial, "Microsoft YaHei", "黑体", sans-serif';
        tailCtx.textAlign = 'center';
        tailCtx.textBaseline = 'middle';
        tailCtx.fillText('反', 256, 256);
        
        // 添加文字阴影
        tailCtx.shadowColor = 'rgba(0, 0, 0, 0.5)';
        tailCtx.shadowBlur = 10;
        tailCtx.shadowOffsetX = 3;
        tailCtx.shadowOffsetY = 3;
        tailCtx.fillText('反', 256, 256);
        
        const tailTexture = new THREE.CanvasTexture(tailCanvas);
        tailTexture.anisotropy = renderer.capabilities.getMaxAnisotropy(); // 提高纹理质量
        tailMaterial.map = tailTexture;
        
        scene.add(coin);

        // 硬币物理体
        const coinShape = new CANNON.Cylinder(
            coinRadius, coinRadius, coinThickness, 20
        );
        const coinBody = new CANNON.Body({ 
            mass: 1,
            position: new CANNON.Vec3(0, 5, 0)
        });
        coinBody.addShape(coinShape);
        world.addBody(coinBody);

        // 抛硬币函数
        function flipCoin() {
            // 重置硬币位置
            coinBody.position.set(0, 5, 0);
            coinBody.velocity.setZero();
            coinBody.angularVelocity.setZero();
            
            // 给硬币一个随机的初始速度和旋转
            const velocity = new CANNON.Vec3(
                (Math.random() - 0.5) * 3,
                5 + Math.random() * 2,
                (Math.random() - 0.5) * 3
            );
            coinBody.velocity.copy(velocity);
            
            // 给硬币一个随机的旋转速度
            const angularVelocity = new CANNON.Vec3(
                Math.random() * 20 - 10,
                Math.random() * 20 - 10,
                Math.random() * 20 - 10
            );
            coinBody.angularVelocity.copy(angularVelocity);
        }

        // 检测硬币是否停止
        let isFlipping = false;
        let hasSettled = false;
        let lastPosition = new CANNON.Vec3();
        let stabilityCounter = 0;

        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            
            // 更新控制器
            controls.update();
            
            // 更新物理世界
            world.step(1/60);
            
            // 同步硬币位置和旋转
            coin.position.copy(coinBody.position);
            coin.quaternion.copy(coinBody.quaternion);
            
            // 检测硬币是否停止
            if (coinBody.velocity.length() < 0.1 && 
                coinBody.angularVelocity.length() < 0.1 && 
                coinBody.position.y < 1) {
                
                if (!hasSettled && isFlipping) {
                    // 检查硬币的位置是否稳定
                    const currentPosition = new CANNON.Vec3().copy(coinBody.position);
                    const diff = currentPosition.vsub(lastPosition);
                    
                    if (diff.length() < 0.001) {
                        stabilityCounter++;
                        
                        if (stabilityCounter > 60) { // 等待约1秒确认稳定
                            hasSettled = true;
                            isFlipping = false;
                            
                            // 检测硬币朝向
                            const normalVector = new THREE.Vector3(0, 1, 0);
                            const coinNormal = new THREE.Vector3(0, 1, 0).applyQuaternion(coin.quaternion);
                            const dotProduct = normalVector.dot(coinNormal);
                            
                            if (dotProduct > 0) {
                                resultElem.textContent = '硬币结果: 正面 (红色)';
                                resultElem.style.color = '#8B0000'; // 结果文字颜色与硬币上的文字颜色匹配
                            } else {
                                resultElem.textContent = '硬币结果: 反面 (蓝色)';
                                resultElem.style.color = '#00008B';
                            }
                        }
                    } else {
                        stabilityCounter = 0;
                    }
                    
                    lastPosition.copy(coinBody.position);
                }
            } else {
                hasSettled = false;
                stabilityCounter = 0;
            }
            
            renderer.render(scene, camera);
        }

        // 窗口大小调整
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // 初始抛硬币按钮事件
        flipButton.onclick = () => {
            flipCoin();
            isFlipping = true;
            hasSettled = false;
            stabilityCounter = 0;
            resultElem.textContent = '硬币正在翻转...';
            resultElem.style.color = '#000000'; // 重置结果文字颜色
        };

        // 资源加载完成后移除加载提示
        window.addEventListener('load', () => {
            loadingElem.style.display = 'none';
            // 初始化一次抛硬币，展示初始状态
            setTimeout(() => {
                flipCoin();
                isFlipping = true;
            }, 500);
        });

        animate();
    </script>
</body>
</html>