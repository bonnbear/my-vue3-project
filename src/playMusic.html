
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue 3 音乐播放器 - 完整版</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #1e1e1e;
            color: #fff;
            overflow: hidden;
        }

        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }

        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }

        .slide-enter-active, .slide-leave-active {
            transition: transform 0.3s ease;
        }

        .slide-enter-from {
            transform: translateX(100%);
        }

        .slide-leave-to {
            transform: translateX(-100%);
        }

        .app {
            display: flex;
            height: 100vh;
        }

        /* 侧边栏 */
        .sidebar {
            width: 240px;
            background-color: #2a2a2a;
            padding: 20px 0;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        .sidebar-section {
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .sidebar-title {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .sidebar-item {
            padding: 8px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            position: relative;
        }

        .sidebar-item::before {
            content: '';
            position: absolute;
            left: -20px;
            width: 4px;
            height: 100%;
            background-color: #ff3b30;
            transform: scaleY(0);
            transition: transform 0.2s;
        }

        .sidebar-item:hover {
            color: #ff3b30;
            padding-left: 10px;
        }

        .sidebar-item.active {
            color: #ff3b30;
        }

        .sidebar-item.active::before {
            transform: scaleY(1);
        }

        .sidebar-item svg {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        /* 主内容区 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* 顶部栏 */
        .top-bar {
            height: 60px;
            background-color: #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid #3a3a3a;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #3a3a3a;
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background-color: #4a4a4a;
            transform: scale(1.1);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .search-box {
            width: 300px;
            height: 36px;
            background-color: #3a3a3a;
            border: none;
            border-radius: 8px;
            padding: 0 15px;
            color: #fff;
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-box:focus {
            outline: none;
            background-color: #4a4a4a;
            width: 350px;
        }

        .search-box::placeholder {
            color: #999;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #ff3b30;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        /* 内容区域 */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #1e1e1e;
        }

        .content-header {
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease;
        }

        .content-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        /* 专辑网格 */
        .album-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        .album-item {
            cursor: pointer;
            transition: all 0.3s;
            animation: fadeIn 0.5s ease backwards;
            position: relative;
            overflow: hidden;
        }

        .album-item:nth-child(n) {
            animation-delay: calc(0.05s * var(--index));
        }

        .album-item:hover {
            transform: translateY(-5px);
        }

        .album-item:hover .album-cover {
            filter: brightness(0.8);
        }

        .album-item:hover .play-overlay {
            opacity: 1;
        }

        .album-cover {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #3a3a3a;
            transition: all 0.3s;
        }

        .play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.3s;
            border-radius: 8px;
        }

        .play-overlay-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #ff3b30;
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .play-overlay-btn:hover {
            transform: scale(1.1);
        }

        .album-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .album-artist {
            font-size: 12px;
            color: #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 歌曲列表 */
        .track-list {
            margin-top: 30px;
        }

        .track-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            animation: fadeIn 0.5s ease backwards;
        }

        .track-item:hover {
            background-color: #2a2a2a;
        }

        .track-item.active {
            background-color: #3a3a3a;
        }

        .track-number {
            width: 30px;
            color: #999;
            font-size: 14px;
        }

        .track-info {
            flex: 1;
            margin-left: 15px;
        }

        .track-name {
            font-size: 14px;
            margin-bottom: 3px;
        }

        .track-artist {
            font-size: 12px;
            color: #999;
        }

        .track-duration {
            color: #999;
            font-size: 14px;
        }

        /* 播放控制栏 */
        .player-bar {
            height: 90px;
            background-color: #2a2a2a;
            border-top: 1px solid #3a3a3a;
            display: flex;
            align-items: center;
            padding: 0 20px;
            position: relative;
        }

        .player-info {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .player-cover {
            width: 56px;
            height: 56px;
            border-radius: 4px;
            margin-right: 15px;
            background-color: #3a3a3a;
            position: relative;
            overflow: hidden;
        }

        .player-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-cover.playing::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background-color: rgba(255, 59, 48, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 2s infinite;
        }

        .player-details {
            flex: 1;
            min-width: 0;
        }

        .player-title {
            font-size: 14px;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-artist {
            font-size: 12px;
            color: #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 0 40px;
        }

        .control-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            position: relative;
        }

        .control-btn:hover {
            background-color: #3a3a3a;
            transform: scale(1.1);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn svg {
            width: 24px;
            height: 24px;
        }

        .play-btn {
            background-color: #ff3b30;
            padding: 12px;
        }

        .play-btn:hover {
            background-color: #ff5040;
        }

        .play-btn svg {
            width: 28px;
            height: 28px;
        }

        .progress-section {
            flex: 2;
            margin: 0 40px;
        }

        .progress-time {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            color: #999;
        }

        .progress-bar {
            height: 4px;
            background-color: #3a3a3a;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background-color: #ff3b30;
            border-radius: 2px;
            position: relative;
            transition: width 0.1s linear;
        }

        .progress-handle {
            position: absolute;
            top: 50%;
            right: -6px;
            width: 12px;
            height: 12px;
            background-color: #fff;
            border-radius: 50%;
            transform: translateY(-50%);
            cursor: grab;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .progress-bar:hover .progress-handle {
            opacity: 1;
        }

        .progress-handle:active {
            cursor: grabbing;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            padding: 4px;
        }

        .volume-slider {
            width: 100px;
            height: 4px;
            background-color: #3a3a3a;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .volume-fill {
            height: 100%;
            background-color: #fff;
            border-radius: 2px;
            transition: width 0.1s;
        }

        /* 加载动画 */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #3a3a3a;
            border-top-color: #ff3b30;
            border-radius: 50%;
            animation: rotate 1s linear infinite;
        }

        /* 错误提示 */
        .error-message {
            background-color: #ff3b30;
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            animation: fadeIn 0.3s ease;
        }

        /* 艺人页面 */
        .artist-header {
            display: flex;
            align-items: flex-end;
            margin-bottom: 40px;
            padding: 40px 0;
            background: linear-gradient(to bottom, rgba(255, 59, 48, 0.2), transparent);
            animation: fadeIn 0.5s ease;
        }

        .artist-image {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin-right: 30px;
            object-fit: cover;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .artist-info h1 {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .artist-stats {
            color: #999;
            font-size: 14px;
        }

        /* 播放列表页面 */
        .playlist-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }

        .playlist-cover {
            width: 200px;
            height: 200px;
            border-radius: 8px;
            margin-right: 30px;
            object-fit: cover;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .playlist-info h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .playlist-meta {
            color: #999;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .playlist-actions {
            display: flex;
            gap: 15px;
        }

        .btn-primary {
            background-color: #ff3b30;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: #ff5040;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: transparent;
            color: #fff;
            border: 1px solid #3a3a3a;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background-color: #3a3a3a;
            transform: translateY(-2px);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .album-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .search-box {
                width: 200px;
            }

            .search-box:focus {
                width: 250px;
            }

            .progress-section {
                margin: 0 20px;
            }

            .player-controls {
                margin: 0 20px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="app">
            <!-- 侧边栏 -->
            <div class="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">Apple Music</div>
                    <router-link to="/" custom v-slot="{ navigate, isActive }">
                        <div class="sidebar-item" :class="{ active: isActive }" @click="navigate">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                            </svg>
                            浏览
                        </div>
                    </router-link>
                    <router-link to="/artists" custom v-slot="{ navigate, isActive }">
                        <div class="sidebar-item" :class="{ active: isActive }" @click="navigate">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            艺人
                        </div>
                    </router-link>
                    <router-link to="/playlists" custom v-slot="{ navigate, isActive }">
                        <div class="sidebar-item" :class="{ active: isActive }" @click="navigate">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/>
                            </svg>
                            播放列表
                        </div>
                    </router-link>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">资料库</div>
                    <div class="sidebar-item" @click="showRecentlyPlayed">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/>
                        </svg>
                        最近播放
                    </div>
                    <div class="sidebar-item" @click="showFavorites">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                        喜爱的歌曲
                    </div>
                    <div class="sidebar-item">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                        </svg>
                        专辑
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">播放列表</div>
                    <div class="sidebar-item" v-for="playlist in userPlaylists" :key="playlist.id">
                        {{ playlist.name }}
                    </div>
                </div>
            </div>

            <!-- 主内容区 -->
            <div class="main-content">
                <!-- 顶部栏 -->
                <div class="top-bar">
                    <div class="nav-buttons">
                        <button class="nav-btn" @click="goBack" :disabled="!canGoBack">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                            </svg>
                        </button>
                        <button class="nav-btn" @click="goForward" :disabled="!canGoForward">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        </button>
                    </div>
                    <input type="text" class="search-box" placeholder="搜索音乐、艺人、专辑..." v-model="searchQuery" @input="handleSearch">
                    <div class="user-menu">
                        <div class="user-avatar">U</div>
                    </div>
                </div>

                <!-- 路由内容 -->
                <router-view v-slot="{ Component }">
                    <transition name="fade" mode="out-in">
                        <component :is="Component" />
                    </transition>
                </router-view>

                <!-- 播放控制栏 -->
                <div class="player-bar">
                    <div class="player-info">
                        <div class="player-cover" :class="{ playing: isPlaying }">
                            <img :src="currentTrack.cover" v-if="currentTrack.cover">
                        </div>
                        <div class="player-details">
                            <div class="player-title">{{ currentTrack.title || '未在播放' }}</div>
                            <div class="player-artist">{{ currentTrack.artist || '-' }}</div>
                        </div>
                    </div>

                    <div class="player-controls">
                        <button class="control-btn" @click="previousTrack">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                            </svg>
                        </button>
                        <button class="control-btn play-btn" @click="togglePlay">
                            <svg v-if="!isPlaying" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                            <svg v-else viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                            </svg>
                        </button>
                        <button class="control-btn" @click="nextTrack">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                            </svg>
                        </button>
                    </div>

                    <div class="progress-section">
                        <div class="progress-time">
                            <span>{{ formatTime(currentTime) }}</span>
                            <span>{{ formatTime(duration) }}</span>
                        </div>
                        <div class="progress-bar" @click="seekTo" ref="progressBar">
                            <div class="progress-fill" :style="{ width: progressPercent + '%' }">
                                <div class="progress-handle" 
                                     @mousedown="startDrag"
                                     @touchstart="startDrag"></div>
                            </div>
                        </div>
                    </div>

                    <div class="volume-control">
                        <button class="volume-btn" @click="toggleMute">
                            <svg v-if="volume > 0" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                            </svg>
                            <svg v-else width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                            </svg>
                        </button>
                        <div class="volume-slider" @click="setVolume" ref="volumeSlider">
                            <div class="volume-fill" :style="{ width: volume + '%' }"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 音频元素 -->
        <audio ref="audioPlayer" 
               @timeupdate="updateTime" 
               @loadedmetadata="updateDuration"
               @ended="handleTrackEnd"
               @error="handleAudioError"></audio>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch, nextTick, provide, inject } = Vue; // Added provide, inject
        const { createRouter, createWebHashHistory, useRoute, useRouter } = VueRouter;

        // 主页组件
        const Home = {
            template: `
                <div class="content-area">
                    <div class="content-header">
                        <h1 class="content-title">浏览</h1>
                    </div>
                    
                    <div v-if="loading" class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                    
                    <div v-else-if="error" class="error-message">
                        {{ error }}
                    </div>
                    
                    <div v-else>
                        <h2 style="margin-bottom: 20px;">推荐专辑</h2>
                        <div class="album-grid">
                            <div class="album-item" 
                                 v-for="(album, index) in albums" 
                                 :key="album.id"
                                 :style="{ '--index': index }"
                                 @click="player.playAlbum(album)">
                                <div class="album-cover">
                                    <img :src="album.cover" :alt="album.title">
                                    <div class="play-overlay">
                                        <button class="play-overlay-btn">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M8 5v14l11-7z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="album-title">{{ album.title }}</div>
                                <div class="album-artist">{{ album.artist }}</div>
                            </div>
                        </div>
                        
                        <h2 style="margin: 40px 0 20px;">热门歌曲</h2>
                        <div class="track-list">
                            <div class="track-item" 
                                 v-for="(track, index) in tracks" 
                                 :key="track.id"
                                 :class="{ active: isCurrentTrack(track) }"
                                 :style="{ animationDelay: index * 0.05 + 's' }"
                                 @click="player.playTrack(track)">
                                <div class="track-number">{{ index + 1 }}</div>
                                <div class="track-info">
                                    <div class="track-name">{{ track.title }}</div>
                                    <div class="track-artist">{{ track.artist }}</div>
                                </div>
                                <div class="track-duration">{{ track.duration }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const loading = ref(true);
                const error = ref(null);
                const albums = ref([]);
                const tracks = ref([]);
                const player = inject('player'); // Inject shared player

                const isCurrentTrack = (track) => {
                    return player.currentTrack.value.id === track.id;
                };

                const loadData = async () => {
                    try {
                        loading.value = true;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        albums.value = [
                            { id: 1, title: 'Midnights', artist: 'Taylor Swift', cover: 'https://picsum.photos/200?random=1', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
                            { id: 2, title: 'Renaissance', artist: 'Beyoncé', cover: 'https://picsum.photos/200?random=2', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3' },
                            { id: 3, title: 'Harry\'s House', artist: 'Harry Styles', cover: 'https://picsum.photos/200?random=3', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3' },
                            { id: 4, title: 'Un Verano Sin Ti', artist: 'Bad Bunny', cover: 'https://picsum.photos/200?random=4', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3' },
                            { id: 5, title: 'The Car', artist: 'Arctic Monkeys', cover: 'https://picsum.photos/200?random=5', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3' },
                            { id: 6, title: 'Dawn FM', artist: 'The Weeknd', cover: 'https://picsum.photos/200?random=6', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3' }
                        ];

                        tracks.value = [
                            { id: 101, title: 'Anti-Hero', artist: 'Taylor Swift', duration: '3:20', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3', cover: 'https://picsum.photos/200?random=1' },
                            { id: 102, title: 'Unholy', artist: 'Sam Smith & Kim Petras', duration: '2:36', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3', cover: 'https://picsum.photos/200?random=2' },
                            { id: 103, title: 'As It Was', artist: 'Harry Styles', duration: '2:47', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-9.mp3', cover: 'https://picsum.photos/200?random=3' },
                            { id: 104, title: 'I\'m Good (Blue)', artist: 'David Guetta & Bebe Rexha', duration: '2:56', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3', cover: 'https://picsum.photos/200?random=4' },
                            { id: 105, title: 'Tití Me Preguntó', artist: 'Bad Bunny', duration: '4:03', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-11.mp3', cover: 'https://picsum.photos/200?random=5' }
                        ];

                        loading.value = false;
                    } catch (err) {
                        error.value = '加载数据失败，请稍后重试';
                        loading.value = false;
                    }
                };

                onMounted(() => {
                    loadData();
                });

                return {
                    loading,
                    error,
                    albums,
                    tracks,
                    player, // Expose player for template
                    isCurrentTrack
                };
            }
        };

        // 艺人页面组件
        const Artists = {
            template: `
                <div class="content-area">
                    <div class="artist-header">
                        <img class="artist-image" src="https://picsum.photos/200?random=artist" alt="Artist">
                        <div class="artist-info">
                            <h1>Taylor Swift</h1>
                            <div class="artist-stats">1,234,567 位听众 · 89 首歌曲</div>
                        </div>
                    </div>
                    
                    <div class="playlist-actions">
                        <button class="btn-primary">播放</button>
                        <button class="btn-secondary">关注</button>
                    </div>
                    
                    <h2 style="margin: 30px 0 20px;">热门歌曲</h2>
                    <div class="track-list">
                        <div class="track-item" v-for="(track, index) in artistTracks" :key="track.id" @click="player.playTrack(track)">
                            <div class="track-number">{{ index + 1 }}</div>
                            <div class="track-info">
                                <div class="track-name">{{ track.title }}</div>
                                <div class="track-artist">{{ track.album }}</div>
                            </div>
                            <div class="track-duration">{{ track.duration }}</div>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const player = inject('player');
                const artistTracks = ref([
                    { id: 201, title: 'Anti-Hero', album: 'Midnights', duration: '3:20', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', cover: 'https://picsum.photos/200?random=ts1' },
                    { id: 202, title: 'Lavender Haze', album: 'Midnights', duration: '3:22', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3', cover: 'https://picsum.photos/200?random=ts2' },
                    { id: 203, title: 'Blank Space', album: '1989', duration: '3:51', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3', cover: 'https://picsum.photos/200?random=ts3' },
                    { id: 204, title: 'Style', album: '1989', duration: '3:51', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3', cover: 'https://picsum.photos/200?random=ts4' },
                    { id: 205, title: 'Love Story', album: 'Fearless', duration: '3:55', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3', cover: 'https://picsum.photos/200?random=ts5' }
                ]);

                return {
                    artistTracks,
                    player
                };
            }
        };

        // 播放列表页面组件
        const Playlists = {
            template: `
                <div class="content-area">
                    <div class="playlist-header">
                        <img class="playlist-cover" src="https://picsum.photos/200?random=playlist" alt="Playlist">
                        <div class="playlist-info">
                            <h1>我喜欢的音乐</h1>
                            <div class="playlist-meta">
                                创建者：用户 · 25 首歌曲 · 1小时32分钟
                            </div>
                            <div class="playlist-actions">
                                <button class="btn-primary">播放</button>
                                <button class="btn-secondary">随机播放</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="track-list">
                        <div class="track-item" v-for="(track, index) in playlistTracks" :key="track.id" @click="player.playTrack(track)">
                            <div class="track-number">{{ index + 1 }}</div>
                            <div class="track-info">
                                <div class="track-name">{{ track.title }}</div>
                                <div class="track-artist">{{ track.artist }}</div>
                            </div>
                            <div class="track-duration">{{ track.duration }}</div>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const player = inject('player');
                const playlistTracks = ref([
                    { id: 301, title: 'Flowers', artist: 'Miley Cyrus', duration: '3:20', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-12.mp3', cover: 'https://picsum.photos/200?random=pl1' },
                    { id: 302, title: 'Kill Bill', artist: 'SZA', duration: '2:33', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-13.mp3', cover: 'https://picsum.photos/200?random=pl2' },
                    { id: 303, title: 'Creepin\'', artist: 'Metro Boomin, The Weeknd, 21 Savage', duration: '3:41', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3', cover: 'https://picsum.photos/200?random=pl3' },
                    { id: 304, title: 'Boy\'s a Liar Pt. 2', artist: 'PinkPantheress, Ice Spice', duration: '2:12', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3', cover: 'https://picsum.photos/200?random=pl4' },
                    { id: 305, title: 'Karma', artist: 'Taylor Swift', duration: '3:24', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-16.mp3', cover: 'https://picsum.photos/200?random=pl5' }
                ]);

                return {
                    playlistTracks,
                    player
                };
            }
        };

        // 播放器逻辑
        function usePlayer() {
            const audioPlayer = ref(null); // This will be set in App.vue's onMounted
            const isPlaying = ref(false);
            const currentTrack = ref({});
            const currentTime = ref(0);
            const duration = ref(0);
            const volume = ref(70); // Default volume
            const progressPercent = computed(() => {
                return duration.value > 0 ? (currentTime.value / duration.value) * 100 : 0;
            });

            const playTrack = async (track) => {
                if (!audioPlayer.value) {
                    console.error('Audio player not initialized');
                    return;
                }
                
                currentTrack.value = track;
                // Ensure track has a URL and cover, provide defaults if necessary
                audioPlayer.value.src = track.url || 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3';
                
                try {
                    await audioPlayer.value.play();
                    isPlaying.value = true;
                } catch (error) {
                    console.error('播放失败:', error);
                    isPlaying.value = false; // Ensure isPlaying is false on error
                }
            };

            const playAlbum = (album) => {
                // Play the first track of the album (or a representative track)
                // Ensure the album object or its tracks have necessary info (url, cover)
                const firstTrack = {
                    id: album.id || Date.now(), // Ensure unique ID
                    title: album.title + ' - Track 1', // Or a specific track title if available
                    artist: album.artist,
                    cover: album.cover || 'https://picsum.photos/200?random=default',
                    url: album.url || (album.tracks && album.tracks[0] ? album.tracks[0].url : 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3')
                };
                playTrack(firstTrack);
            };

            const togglePlay = async () => {
                if (!audioPlayer.value || !audioPlayer.value.src) { // Check if src is set
                    console.log('No track loaded to play/pause.');
                    if (currentTrack.value && currentTrack.value.url) { // Attempt to load current track if src is missing
                        await playTrack(currentTrack.value);
                    }
                    return;
                }
                
                if (isPlaying.value) {
                    audioPlayer.value.pause();
                    isPlaying.value = false;
                } else {
                    try {
                        await audioPlayer.value.play();
                        isPlaying.value = true;
                    } catch (error) {
                        console.error('播放失败:', error);
                        isPlaying.value = false;
                    }
                }
            };

            const previousTrack = () => {
                console.log('Previous track (not implemented)');
                // To implement: need a queue/playlist and current index
            };

            const nextTrack = () => {
                console.log('Next track (not implemented)');
                // To implement: need a queue/playlist and current index
            };

            const updateTime = () => {
                if (audioPlayer.value) {
                    currentTime.value = audioPlayer.value.currentTime;
                }
            };

            const updateDuration = () => {
                if (audioPlayer.value) {
                    duration.value = audioPlayer.value.duration;
                }
            };

            const seekTo = (event) => {
                if (!audioPlayer.value || !duration.value || isNaN(duration.value)) return;
                
                const progressBar = event.currentTarget; // progressBar is the div clicked
                const rect = progressBar.getBoundingClientRect();
                const percent = (event.clientX - rect.left) / rect.width;
                audioPlayer.value.currentTime = percent * duration.value;
            };

            const setVolume = (event) => {
                if (!audioPlayer.value) return;
                const volumeSlider = event.currentTarget;
                const rect = volumeSlider.getBoundingClientRect();
                const percent = Math.max(0, Math.min(1, (event.clientX - rect.left) / rect.width));
                volume.value = percent * 100;
                audioPlayer.value.volume = percent;
            };
            
            watch(volume, (newVolume) => {
                if (audioPlayer.value) {
                    audioPlayer.value.volume = newVolume / 100;
                }
            });


            const toggleMute = () => {
                if (!audioPlayer.value) return;
                if (volume.value > 0) {
                    // Storing previous volume to unmute to it could be a feature
                    volume.value = 0;
                } else {
                    volume.value = 70; // Default unmute volume
                }
                audioPlayer.value.volume = volume.value / 100;
            };

            const handleTrackEnd = () => {
                isPlaying.value = false;
                // currentTime.value = 0; // Optionally reset time
                // nextTrack(); // Call next track when implemented
                console.log('Track ended');
            };

            const handleAudioError = (errorEvent) => {
                console.error('音频错误:', audioPlayer.value.error, errorEvent);
                isPlaying.value = false;
                // Potentially display an error to the user
            };

            const formatTime = (seconds) => {
                if (seconds === null || typeof seconds === 'undefined' || isNaN(seconds)) return '0:00';
                
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const startDrag = (event) => {
                if (!audioPlayer.value || !duration.value || isNaN(duration.value)) return;
                event.preventDefault();
                
                const progressBar = event.currentTarget.closest('.progress-bar'); // Get the parent progress-bar
                if (!progressBar) return;

                const updateProgressOnDrag = (e) => {
                    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                    if (typeof clientX === 'undefined') return;

                    const rect = progressBar.getBoundingClientRect();
                    const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
                    
                    currentTime.value = percent * duration.value; // Update currentTime visually
                    // audioPlayer.value.currentTime will be set on mouseup/touchend to avoid too many seeks
                };

                const stopDrag = (e) => {
                    // Final seek operation
                    const clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
                     if (typeof clientX !== 'undefined' && audioPlayer.value && duration.value) {
                        const rect = progressBar.getBoundingClientRect();
                        const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
                        audioPlayer.value.currentTime = percent * duration.value;
                    }

                    document.removeEventListener('mousemove', updateProgressOnDrag);
                    document.removeEventListener('mouseup', stopDrag);
                    document.removeEventListener('touchmove', updateProgressOnDrag);
                    document.removeEventListener('touchend', stopDrag);
                };

                document.addEventListener('mousemove', updateProgressOnDrag);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchmove', updateProgressOnDrag);
                document.addEventListener('touchend', stopDrag);
            };

            return {
                audioPlayer, // Expose ref to be set by App.vue
                isPlaying,
                currentTrack,
                currentTime,
                duration,
                volume,
                progressPercent,
                playTrack,
                playAlbum,
                togglePlay,
                previousTrack,
                nextTrack,
                // updateTime, // Handled by audio element event
                // updateDuration, // Handled by audio element event
                seekTo,
                setVolume,
                toggleMute,
                // handleTrackEnd, // Handled by audio element event
                // handleAudioError, // Handled by audio element event
                formatTime,
                startDrag
            };
        }

        // 路由配置
        const routes = [
            { path: '/', component: Home },
            { path: '/artists', component: Artists },
            { path: '/playlists', component: Playlists }
        ];

        const router = createRouter({
            history: createWebHashHistory(),
            routes
        });

        // 主应用
        const app = createApp({
            setup() {
                const route = useRoute();
                const appRouter = useRouter(); // Renamed to avoid conflict with global router
                const searchQuery = ref('');
                const userPlaylists = ref([
                    { id: 1, name: '睡前音乐' },
                    { id: 2, name: '运动歌单' },
                    { id: 3, name: '工作专注' }
                ]);

                // Create a single player instance
                const playerInstance = usePlayer();

                // Provide the player instance to descendant components
                provide('player', playerInstance);

                const canGoBack = ref(false);
                const canGoForward = ref(false); // This needs proper history tracking to enable

                const goBack = () => {
                    appRouter.back();
                };

                const goForward = () => {
                    appRouter.forward();
                };

                const handleSearch = () => {
                    console.log('搜索:', searchQuery.value);
                };

                const showRecentlyPlayed = () => {
                    console.log('显示最近播放');
                };

                const showFavorites = () => {
                    console.log('显示喜爱的歌曲');
                };

                appRouter.afterEach((to, from) => {
                    nextTick(() => {
                        // A more robust way to check history state might be needed for canGoForward
                        canGoBack.value = window.history.state && window.history.state.back !== null;
                        // For canGoForward, you might need to manage a custom history stack or check window.history.state.forward
                        // For simplicity, keeping it basic. Vue Router doesn't directly expose "canGoForward" easily.
                        canGoForward.value = window.history.state && window.history.state.forward !== null;
                    });
                });
                
                // Get the actual audio DOM element and assign it to the player's ref
                const audioPlayerElement = ref(null); // This ref is for the <audio> tag in App.vue template
                
                onMounted(() => {
                    // Assign the DOM element to the playerInstance's audioPlayer ref
                    if (audioPlayerElement.value) {
                        playerInstance.audioPlayer.value = audioPlayerElement.value;
                        // Set initial volume on the audio element itself
                        playerInstance.audioPlayer.value.volume = playerInstance.volume.value / 100;
                    } else {
                        console.error("Could not find audio player element in App.vue onMounted");
                    }
                });

                return {
                    searchQuery,
                    userPlaylists,
                    // Expose playerInstance properties for App.vue template
                    isPlaying: playerInstance.isPlaying,
                    currentTrack: playerInstance.currentTrack,
                    currentTime: playerInstance.currentTime,
                    duration: playerInstance.duration,
                    volume: playerInstance.volume,
                    progressPercent: playerInstance.progressPercent,
                    togglePlay: playerInstance.togglePlay,
                    previousTrack: playerInstance.previousTrack,
                    nextTrack: playerInstance.nextTrack,
                    seekTo: playerInstance.seekTo,
                    setVolume: playerInstance.setVolume,
                    toggleMute: playerInstance.toggleMute,
                    formatTime: playerInstance.formatTime,
                    startDrag: playerInstance.startDrag,
                    // Audio element events are bound directly on the <audio> tag
                    // So we don't need to expose updateTime, updateDuration, handleTrackEnd, handleAudioError from playerInstance here
                    // for the template, but they are used internally by the <audio> tag's @event handlers.
                    updateTime: playerInstance.updateTime, // For direct binding on audio tag
                    updateDuration: playerInstance.updateDuration, // For direct binding on audio tag
                    handleTrackEnd: playerInstance.handleTrackEnd, // For direct binding on audio tag
                    handleAudioError: playerInstance.handleAudioError, // For direct binding on audio tag


                    canGoBack,
                    canGoForward,
                    goBack,
                    goForward,
                    handleSearch,
                    showRecentlyPlayed,
                    showFavorites,
                    audioPlayerElement // expose ref for template
                };
            }
        });

        app.use(router);
        app.mount('#app');
    </script>
</body>
</html>
